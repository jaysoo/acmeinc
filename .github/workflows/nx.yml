name: Run NX Jobs
on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

env:
  NX_BRANCH: ${{ github.event.pull_request.head.ref || github.ref_name }}
  NX_RUN_GROUP: ${{ github.run_id }}
  NX_CLOUD_DISTRIBUTED_EXECUTION: 'true'

jobs:
  nx-agent:
    name: nx-agent

    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - name: ⚙️ Use Node.js
        id: setup-node
        uses: actions/setup-node@v3
        with:
          node-version: '16.x'
          cache: yarn

      - name: 📦 Install dependencies
        run: yarn install --immutable --mode=skip-build

      - name: 🤖 Start Nx Agent ${{ matrix.agent }}
        run: ./node_modules/.bin/nx-cloud start-agent

  nx:
    name: Run nx commands
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - name: ⚙️ Use Node.js
        id: setup-node
        uses: actions/setup-node@v3
        with:
          node-version: '16.x'
          cache: yarn

      - name: 📦 Install dependencies
        run: yarn install --immutable --mode=skip-build

      - name: ☁ Start Nx CI Run
        run: npx nx-cloud start-ci-run

      - name: Coverage Cache (PR)
        if: github.ref != 'refs/heads/main'
        id: coverage-cache-pr
        uses: actions/cache@v3
        with:
          path: coverage
          key: coverage-pr-${{ github.sha }}
          restore-keys: |
            coverage-pr-${{ github.sha }}
            coverage-main

      - name: Coverage Cache (main)
        if: github.ref == 'refs/heads/main'
        id: coverage-cache-main
        uses: actions/cache@v3
        with:
          path: coverage
          key: coverage-main
          restore-keys: |
            coverage-main

      - name: Generate Initial Test Coverage
        if: github.ref == 'refs/heads/main'
        run: |
          if [ ! -d "coverage" ]; then ./node_modules/.bin/nx run-many --target=test --all --codeCoverage; fi

      - name: ✅ Test and Lint (PR)
        if: github.ref != 'refs/heads/main'
        uses: JamesHenry/parallel-bash-commands@v0.1
        with:
          cmd1: ./node_modules/.bin/nx affected --base=origin/main --target=test --parallel --codeCoverage

      - name: ✅ Test and Lint (main)
        if: github.ref == 'refs/heads/main'
        uses: JamesHenry/parallel-bash-commands@v0.1
        with:
          cmd1: ./node_modules/.bin/nx affected --base=${{ steps.last_successful_commit.outputs.commit_hash }} --target=test --parallel --codeCoverage

      - name: List
        uses: JamesHenry/parallel-bash-commands@v0.1
        with:
          cmd1: du coverage

      #      - name: 🚦 Codecov
      #        uses: codecov/codecov-action@v3.1.0
      #        with:
      #          token: ${{ secrets.CODECOV_TOKEN }}
      #          files: ./coverage/lcov.info

      - name: 🙅🏼 Stop Nx Agents
        if: always() # also stop nx agents if commands fail or get cancelled
        run: npx nx-cloud stop-all-agents
